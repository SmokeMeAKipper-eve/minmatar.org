---
import { getLangFromUrl, useTranslations, useTranslatedPath } from '@i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

import type { Alert, CorporationObject } from '@dtypes/layout_components'

interface Props {
    corporation:            CorporationObject;
    is_user_corporation?:   boolean;
    alert?:                 Alert | false;
}

const {
    corporation,
    alert = false,
    is_user_corporation = false,
} = Astro.props

import { get_corporation_logo, get_alliance_logo } from '@helpers/eve_image_server';

import { get_app_url } from '@helpers/env'
const CORPORATION_ITEM_PARTIAL_URL = `${get_app_url()}/partials/corporation_item_component/`

import { query_string } from '@helpers/string';
const CORPORATION_REQUEST_STATUS_PARTIAL_URL = `${get_app_url()}/partials/corporation_request_status_item`

import FixedFluid from '@components/compositions/FixedFluid.astro';
import Flexblock from '@components/compositions/Flexblock.astro';
import FlexInline from '@components/compositions/FlexInline.astro';

import Button from '@components/blocks/Button.astro';
import Tag from '@components/blocks/Tag.astro';
import ButtonStack from './ButtonStack.astro';
---

<FixedFluid
    width='64px'
    class="[ corporation-item items-center ]"
    id={`corporation-item-${corporation.corporation_id}`}
    x-data={`{
        corporation_item_init() {
            ${alert !== false ? `show_alert_dialog(${JSON.stringify(alert)})` : ''}
        }
    }`}
    x-init="corporation_item_init()"
>
    <picture class="[ border ]">
        <img src={get_corporation_logo(corporation.corporation_id, 64)} width="64" height="64" alt={`${corporation.corporation_name} ${t('corporation_logo')}`} />
    </picture>
    <FlexInline justification='space-between' class="[ items-center ]">
        <Flexblock gap='0' class="[ grow ]">
            <span class="[ text-[var(--highlight)] ]">
                {corporation.corporation_name}
            </span>
            {corporation.alliance_id &&
                <FixedFluid
                    width='24px'
                    class="[ items-center w-full ]"
                    gap='var(--space-3xs)'
                >
                    <picture>
                        <img src={get_alliance_logo(corporation.alliance_id)} width="24" height="24" alt={`${corporation.alliance_name} ${t('alliance_logo')}`} />
                    </picture>
                    <span>
                        <small>
                            {corporation.alliance_name}
                        </small>
                    </span>                        
                </FixedFluid>
            }
        </Flexblock>
        {is_user_corporation ?
            <Tag color='green' text={t('joined')} />
            :
            <ButtonStack>
                {!corporation?.status &&
                    <Button
                        type="button"
                        size='sm'
                        color='green'
                        x-bind:disabled="disabled"
                        x-data={`{
                            disabled: false,
                            show_join_request_dialog() {
                                this.disabled = true
                                
                                show_confirm_dialog({
                                    title: '${t('corporation_join_request_dialog_title')}',
                                    partial: '${translatePath('/partials/dialog_with_corporation/')}?${query_string({
                                        corporation_id: corporation.corporation_id,
                                        corporation_name: corporation.corporation_name,
                                        alliance_id: corporation.alliance_id,
                                        alliance_name: corporation.alliance_name,
                                        corporation_type: corporation.corporation_type,
                                        status: corporation.status,
                                        message: t('corporation_join_request_dialog_text')
                                    })}',
                                    return_on_accept: ${corporation.corporation_id},
                                    hx: {
                                        method: 'post',
                                        url: '${CORPORATION_REQUEST_STATUS_PARTIAL_URL}?${query_string({
                                            corporation: JSON.stringify(corporation),
                                        })}',
                                        target: '${`#corporation-status-${corporation.corporation_id}`}',
                                        swap: 'outerHTML transition:true'
                                    }
                                }).then( (corporation_id) => { this.disabled = !!corporation_id } )
                            }
                        }`}
                        x-on:click="show_join_request_dialog()"
                        type="button"
                    >
                        {t('enlist_today')}
                    </Button>
                }
                {corporation?.status == 'requested' &&
                    <Tag color='alliance-blue' text={t('pending')} />
                }
            </ButtonStack>
        }
    </FlexInline>
</FixedFluid>

<style lang="scss">
    .corporation-item {
        picture {
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1/1;
        }

        a {
            display: inline-block;

            > .flex-inline {
                max-width: fit-content;
            }
        }
    }
</style>